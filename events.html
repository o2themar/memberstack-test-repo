<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upcoming Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Memberstack webflow package -->
<!-- Memberstack webflow package -->
<script data-memberstack-app="app_cmgwwkrmn00020tvugegz8x01" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>
  <style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 16px}</style>
  <style>
    body{font-family:system-ui;max-width:760px;margin:40px auto;padding:0 16px}
    .event{border:1px solid #ddd;padding:12px;border-radius:8px;margin:12px 0}
    .event h3{margin:0 0 8px}
    .muted{color:#666}
    .btn{cursor:pointer;border:1px solid #333;padding:6px 10px;border-radius:6px;background:#fff}
  </style>
</head>
<body>
  <h1>Upcoming Events</h1>
  <div id="events">Loading...</div>
  <div data-entity="EVENT" data-source="CharityStack" id="2f851036-42da-43fc-a7dd-6bb29f87857f"></div>

  <script>
  const API_LIST_EVENTS = "https://hook.us2.make.com/n6to8zarrq34vkmwrs2rkn9y8dklxgwx";
  const API_SIGNUP      = "https://hook.us2.make.com/iel997i7ybghq9e8ju1mcewf538gn55o";

  const waitForMemberstack = () => new Promise(resolve => {
    const check = () => {
      if (window.$memberstackDom) {
        resolve(window.$memberstackDom);
      } else {
        setTimeout(check, 100);
      }
    };
    check();
  });

  (async () => {
    const list = document.getElementById("events");
    list.textContent = "Loading...";

    try {
      const [ms, eventsData] = await Promise.all([
        waitForMemberstack(),
        fetch(API_LIST_EVENTS).then(res => res.json())
      ]);

      const { data: member } = await ms.getCurrentMember();
      const memberId = member?.id;

      const events = eventsData.array || [];
      list.innerHTML = "";

      if (!events.length) {
        list.textContent = "No upcoming events.";
        return;
      }

      for (const ev of events) {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <h3>${ev.Name}</h3>
          <div class="muted">${new Date(ev.Date).toLocaleString()} - ${ev['End Time']} ${ev.Location ? "â€¢ " + ev.Location : ""}</div>
          <p>${ev.Description || ""}</p>
        `;

        const btn = document.createElement("button");
        btn.className = "btn";
        btn.type = "button";
        btn.textContent = "Register";
        btn.addEventListener("click", async () => {
          if (!memberId) {
            window.location.href = "/memberstack-test-repo/login.html";
            return;
          }
          btn.disabled = true;
          btn.textContent = "Registering...";
          try {
            const res = await fetch(API_SIGNUP, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ member_id: memberId, event_id: ev.id, status: "Confirmed" })
            });
            const data = await res.json();
            if (res.ok && !data.error) {
              btn.textContent = "Registered";
            } else {
              throw new Error(data.error || res.statusText);
            }
          } catch (error) {
            console.error("Error registering", error);
            alert("Could not register. Please try again.");
            btn.disabled = false;
            btn.textContent = "Register";
          }
        });
        div.appendChild(btn);

        list.appendChild(div);
      }
    } catch (error) {
      console.error("Error loading events", error);
      list.textContent = "Unable to load events right now.";
    }
  })();
  </script>
</body>
</html>
